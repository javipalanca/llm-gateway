"""
Pytest configuration and plugins.
"""

import pytest
import sys
from pathlib import Path

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))


def pytest_configure(config):
    """Configure pytest with custom markers."""
    config.addinivalue_line(
        "markers", "asyncio: marks tests as async (deselect with '-m \"not asyncio\"')"
    )
    config.addinivalue_line(
        "markers", "slow: marks tests as slow (deselect with '-m \"not slow\"')"
    )
    config.addinivalue_line(
        "markers", "integration: marks tests as integration tests"
    )
    config.addinivalue_line(
        "markers", "load: marks tests as load tests"
    )
    config.addinivalue_line(
        "markers", "auth: marks tests as authentication tests"
    )
    config.addinivalue_line(
        "markers", "concurrent: marks tests as concurrent/parallel tests"
    )


def pytest_collection_modifyitems(config, items):
    """Modify test collection."""
    for item in items:
        # Mark asyncio tests
        if "asyncio" in item.keywords or "async_http_client" in item.fixturenames:
            item.add_marker(pytest.mark.asyncio)
        
        # Mark slow tests
        if "slow" in item.nodeid or "timeout" in item.nodeid:
            item.add_marker(pytest.mark.slow)
        
        # Mark load tests
        if "load" in item.nodeid or "concurrent" in item.nodeid or "burst" in item.nodeid:
            item.add_marker(pytest.mark.load)


@pytest.fixture(scope="session", autouse=True)
def log_test_session_info(request):
    """Log test session information."""
    print("\n" + "="*70)
    print("LLM Gateway E2E Test Suite")
    print("="*70)
    print(f"Test Session: {request.config.option.verbose > 0 and 'VERBOSE' or 'NORMAL'}")
    print("="*70 + "\n")
    
    yield
    
    print("\n" + "="*70)
    print("Test Session Complete")
    print("="*70 + "\n")
